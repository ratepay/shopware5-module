<?php
/**
 * Copyright (c) 2020 Ratepay GmbH
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

namespace RpayRatePay\Bootstrapping;

use RpayRatePay\Bootstrapping\Database\InstallModels;
use RpayRatePay\Component\Service\ShopwareUtil;

class DatabaseSetup extends Bootstrapper
{
    /**
     * @return mixed|void
     * @throws \Exception
     */
    public function install()
    {
        $setup = new InstallModels(Shopware()->Container()->get('models'));
        $setup->install();
    }

    /**
     * @return mixed|void
     * @throws \Exception
     */
    public function update()
    {
        $setup = new InstallModels(Shopware()->Container()->get('models'));
        $setup->update();

        $this->removeSandboxColumns();
    }

    /**
     * Drops all RatePAY database tables
     *
     * @return mixed|void
     * @throws \Exception
     */
    public function uninstall()
    {
        $setup = new InstallModels(Shopware()->Container()->get('models'));
        $setup->uninstall();
    }

    /**
     * @throws \Exception
     */
    private function removeSandboxColumns()
    {
        if (ShopwareUtil::tableHasColumn('s_core_config_elements', 'RatePaySandboxDE')) {
            try {
                Shopware()->Db()->query(
                    "DELETE FROM `s_core_config_elements` WHERE `s_core_config_elements`.`name` LIKE 'RatePaySandbox%'"
                );
            } catch (\Exception $exception) {
                throw new \Exception("Can't remove Sandbox fields` - " . $exception->getMessage());
            }
        }
    }
}
